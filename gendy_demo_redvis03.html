<!DOCTYPE html>
<html>
    <head>
        <script src="nexusUI.js"></script>
    </head>
    <style type="text/css">
        #canvas{
            width:600px;
            height:300px;
            margin: 60px auto;
            display:block;
            border: 1px solid black;
        }

        h1{
            font-size:15pt;
            font-family:Helvtica;
            display:block;
            margin: auto;
        }
    

        .widg{
            width:50px;
            height:50px;
            display:inline;
        }

        #control{
            position:relative;
            left:26%;
            display:block;
            margin: 30px;
            padding:10px 20px;
        }

        #banner{
            display:block;
            margin: auto;
        }

    </style>
    <body>
        <h1>
            <p>GENDY.JS</p>
            <p>A dynamic stochastic synthesis algorithm</p>
        </h1>


        <canvas id="canvas"></canvas>
       
        
       <canvas nx="button" id="debuggy" class="widg"></canvas>
        <div id="control">
            <canvas nx="button" id="playbutton" class="widg"></canvas>
            <canvas nx="dial" class="widg"></canvas>
            <canvas nx="dial" class="widg"></canvas>
            <canvas nx="dial" class="widg"></canvas>
            <canvas nx="dial" class="widg"></canvas>
            <canvas nx="dial" class="widg"></canvas>
            <canvas nx="dial" class="widg"></canvas>
            <canvas nx="dial" class="widg"></canvas>
        </div>

        <canvas nx="banner" id="banner"></canvas>
    
    </body>
    <script>
        var dStep = 10;
        var dRoom = 10;
        
        var maxA = 0.5;
        var minA = -0.5;
        var aStep = 0.01;
        
        var freq = 0.001;

        nx.onload = function(){

            nx.sendsTo("js");
            nx.showLabels = "true";
            nx.setLabels("true");
            nx.colorize("#000000");

            playbutton.mode = "impulse";
            var playToggle = 0;
            
            debuggy.on('*',function(){
                debug();
            });

            playbutton.on('*',function(){
                
                playToggle = (playToggle + 1)%2;
                console.log(playToggle);
                if(playToggle == 1){
                    pressed();
                } else if(playToggle == 0){
                    stop();
                }
            });

            dial1.label = "x-step size";
            dial1.on("*", function(){
                dStep = dial1.val.value * 20;
                console.log(dStep);
            });

            dial2.on("*", function(){
                dRoom = dial2.val.value * 100;
                console.log(dRoom);
            });

            dial3.on("*", function(){
                maxA = dial3.val.value;
                console.log(maxA);
            });

            dial4.on("*", function(){
                minA = dial4.val.value-1;
                console.log(minA);
            });

            dial5.on("*", function(){
                aStep = dial5.val.value / 10;
                console.log(aStep);
            });

              dial6.on("*", function(){
                freq = dial6.val.value*10;
                console.log(freq);
            });

              dial7.on("*", function(){
                lerpFreq = dial7.val.value/100+0.00001;
                console.log(lerpFreq);
            });
        }

        var canvas = document.getElementById("canvas");
        var context = canvas.getContext('2d');

        canvas.width = 600;
        canvas.height = 300

        var actx = new (AudioContext || wedkitAudioContext)();
        var channels = 1;
        var scriptNode = actx.createScriptProcessor(512,1,1);
        var sine = actx.createOscillator();
        var gain = actx.createGain;
        sine.type = 'sine';
        sine.frequency.value = 200;
        console.log(scriptNode.bufferSize);

        var breakpoint = [];

        function init(num){

            var lastX = 0;
            var last = 0;
            
            for(var i = 0;i < num;i++){
                if(i == 0){

                    //generate breakpoints
                    breakpoint[0] = {
                        x : 0.0,
                        y : 0.0,
                        x1 : 0.0,
                        y1 : 0.0,
                        m : 0.0,
                        b : 0.0
                        };
                   // console.log("point",i, breakpoint[i]);

                } else if(i != 0){

                    
                    breakpoint[i] = {};

                    breakpoint[i].x = (Math.random()*200)+lastX;
                    
                    if(breakpoint[i].x >= scriptNode.bufferSize){
                        breakpoint[i].x = scriptNode.bufferSize-10;
                    }
                    lastX = breakpoint[i].x;

                    breakpoint[i].y = (Math.random()*2)-1;

                    if(i == num-1){
                        breakpoint[i].y = 0;
                    }
                    /*
                    breakpoint[i].x1 = breakpoint[last].x;
                    breakpoint[i].y1 = breakpoint[last].y;

                    breakpoint[i].m = (breakpoint[i].y-breakpoint[i].y1)/(breakpoint[i].x-breakpoint[i].x1); 
                   
                    breakpoint[i].b = breakpoint[i].y-(breakpoint[i].m*breakpoint[i].x); 

                    last = i;
                    */
                } else if(i == num-1){
                    breakpoint[i].y = 0;
                }

            }
           
            console.log(breakpoint); 
        }

        function walk(){
          
            var last = 0;
            var next = 1;
           
            for(var i = 0; i < breakpoint.length;i++){
                if(i != 0){

                    var randomx = Math.floor(Math.random()*2);
                    var x = breakpoint[i].x;
                    
                    if(i != breakpoint.length-1){
                        breakpoint[i].maxD = breakpoint[next].x-dRoom;
                    } else {
                        breakpoint[i].maxD = scriptNode.bufferSize-dRoom;
                    }
                    
                    breakpoint[i].minD = breakpoint[last].x+dRoom;

                    // the random walk, 2 samples in either direction
                    if(randomx == 0){
                        x = x - dStep;
                    } else if(randomx == 1){
                        x = x + dStep;
                    }

                   //bounds on the random walk, if it goes out of bounds, it jumps the difference back in
                    if(x >= breakpoint[i].maxD-dRoom){
                        //x = breakpoint[i].maxD-(x-breakpoint[i].maxD);
                       x = breakpoint[i].maxD-dRoom;
                    } else if(x <= breakpoint[i].minD+dRoom){
                        //x = breakpoint[i].minD-(x-breakpoint[i].minD);
                       x = breakpoint[i].minD+dRoom;
                    }

                //    console.log(randomx, "x ", x);

                    breakpoint[i].x = x;

                    var randomy = Math.floor(Math.random()*2);
                    var y = breakpoint[i].y;

                    if(randomy == 0){
                        y = y - aStep;
                    } else if(randomy == 1){
                        y = y + aStep;
                    }

                    if(y > maxA){
                        y = maxA-(y-maxA);
                        //y = maxA
                    } else if(y < minA){
                        y = minA-(y-minA);
                        //y = minA
                    }

                    //   console.log(randomy,"y ", y);
                    breakpoint[i].y = y;

                } 

                if(i == breakpoint.length-1){
                    breakpoint[i].y = 0;
                    
                }

                //compute the slope and y intercept for these new walking breakpoints
                /*
                breakpoint[i].x1 = breakpoint[last].x;
                breakpoint[i].y1 = breakpoint[last].y;

                breakpoint[i].m = (breakpoint[i].y-breakpoint[i].y1)/(breakpoint[i].x-breakpoint[i].x1); 

                breakpoint[i].b = breakpoint[i].y-(breakpoint[i].m*breakpoint[i].x); 
                */
                last = i;
                next++;
                
            }
            //console.log(" test");
            //
            canvasDraw()

        }

        var index = 0;
        var point = 0;
        var lerpFreq = 0.0001;
        var lerpIndex = 0;


        scriptNode.onaudioprocess = function(audioProcessingEvent){
           // console.log(index);
            var outputBuffer = audioProcessingEvent.outputBuffer;
            var outputData = outputBuffer.getChannelData(0);
            
            
            for(var j = 0; j < outputData.length; j++){
                // linearly interpolate between the new breakpoit positions
               if(point > 0){
                  
                   var y = nx.interp(lerpIndex, breakpoint[point-1].y, breakpoint[point].y);
                        outputData[index] = y; 
                        index+=freq; 
                        lerpIndex+= (1/actx.sampleRate);
                       // console.log(y);
                       if(lerpIndex >= 1){
                        lerpIndex = 0;
                    }
                   
                }
            
             

                if(point <= breakpoint.length) {
                   // console.log("point", point);
                    point++; 
                }  
            
                if(point >= breakpoint.length){
                    point = 0;
                }
                
                var end = breakpoint.length-1;
                //console.log(index, breakpoint[end].x);
                
                if(index >= breakpoint[end].x){
                   // console.log("hey!");
                    index = 0;
                    //use random walk to generate new x/y position for each breakpoint
                    walk(); 
                }   

            }
             

            context.fillStyle = "#f00";
            context.fillRect(index,y*canvas.height+canvas.height/2,5,5);
        }

        function debug(){
            
          //  console.log(index);
            console.log(breakpoint[breakpoint.length-1].y);

            
        }




        function canvasDraw(){
         //   window.requestAnimationFrame(canvasDraw);

            context.globalAlpha = 1
            context.fillStyle = "#EEE"
            context.fillRect(0,0,canvas.width,canvas.height)

            context.globalAlpha = 1
            //this is cool but saving for later
            //context.strokeStyle = "rgb("+breakpoint[1].x%255+","+breakpoint[1].y*100+",0)";
            context.strokeStyle = "black";
            context.lineWidth = 6;

            context.beginPath();
            context.moveTo(0,canvas.height/2)
            for (var i=0;i<breakpoint.length;i++) {
                context.lineTo(breakpoint[i].x,breakpoint[i].y*canvas.height+canvas.height/2)
            }
           // context.lineTo(canvas.width,canvas.height/2)
            context.stroke()
            context.closePath()

        }

        function play(){

            //sine.connect(actx.destination);
           // sine.start();
            scriptNode.connect(actx.destination);
        }

        function stop(){
            scriptNode.disconnect(actx.destination);
        }

        function pressed(){
            init(10);
            console.log(breakpoint[breakpoint.length-1].x);
            play();
            canvasDraw();
        }
    

    </script>
</html>