<!DOCTYPE html>
<html>
    <head>
    <!--     <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>-->
    </head>
    <style type="text/css">
        canvas{
            width:600px;
            height:300px;
            margin:30px auto;
            display:block;
        }
        #play {
            display:block;
            margin:20px auto;
            padding:4px 20px;
        }
    </style>
    <body>
        <canvas id="canvas"></canvas>
       
        <button id="play">play</input>
            <button id="log">log</input>
    
    </body>
    <script>
var canvas = document.getElementById("canvas");
var context = canvas.getContext('2d');

canvas.width = 600;
canvas.height = 300

var actx = new (AudioContext || wedkitAudioContext)();
var channels = 1;
var scriptNode = actx.createScriptProcessor(512,1,1);
var sine = actx.createOscillator();
var gain = actx.createGain;
sine.type = 'sine';
sine.frequency.value = 200;
console.log(scriptNode.bufferSize);

var breakpoint = [];

var D = 10;
var freq = 1;


var start = document.getElementById('play');
start.onclick = pressed;

var log = document.getElementById('log');
log.onclick = debug;

function init(num){

    var lastX = 0;
    var last = 0;
    
    for(var i = 0;i < num;i++){
        if(i == 0){

            //generate breakpoints
            breakpoint[0] = {
                x : 0.0,
                y : 0.0,
                x1 : 0.0,
                y1 : 0.0,
                m : 0.0,
                b : 0.0
                };
           // console.log("point",i, breakpoint[i]);

        } else if(i != 0){

            
            breakpoint[i] = {};

            breakpoint[i].x = (Math.random()*200)+lastX;
            
            if(breakpoint[i].x >= scriptNode.bufferSize){
                breakpoint[i].x = scriptNode.bufferSize-10;
            }
            lastX = breakpoint[i].x;

            breakpoint[i].y = (Math.random()*2)-1;

            if(i == num-1){
                breakpoint[i].y = 0;
            }

            breakpoint[i].x1 = breakpoint[last].x;
            breakpoint[i].y1 = breakpoint[last].y;

            breakpoint[i].m = (breakpoint[i].y-breakpoint[last].y1)/(breakpoint[i].x-breakpoint[last].x1); 
           
            breakpoint[i].b = breakpoint[i].y-(breakpoint[i].m*breakpoint[i].x); 

            last = i;
        } else if(i == num-1){
            breakpoint[i].y = 0;
        }

    }
   
    console.log(breakpoint); 
}

function walk(){
  
    var last = 0;
    var next = 1;
   
    for(var i = 0; i < breakpoint.length;i++){
        if(i != 0){

            var randomx = Math.floor(Math.random()*2);
            var x = breakpoint[i].x;
            
            if(i != breakpoint.length-1){
                breakpoint[i].maxD = breakpoint[next].x-D;
            } else {
                breakpoint[i].maxD = scriptNode.bufferSize-D;
            }
            
            breakpoint[i].minD = breakpoint[last].x+D;
            
            var dStep = 10;

            // the random walk, 2 samples in either direction
            if(randomx == 0){
                x = x - dStep;
            } else if(randomx == 1){
                x = x + dStep;
            }

           //bounds on the random walk, if it goes out of bounds, it jumps the difference back in
            if(x >= breakpoint[i].maxD-D){
                //x = breakpoint[i].maxD-(x-breakpoint[i].maxD);
               x = breakpoint[i].maxD-D;
            } else if(x <= breakpoint[i].minD+D){
                //x = breakpoint[i].minD-(x-breakpoint[i].minD);
               x = breakpoint[i].minD+D;
            }

        //    console.log(randomx, "x ", x);

            breakpoint[i].x = x;

            var randomy = Math.floor(Math.random()*2);
            var y = breakpoint[i].y;
            var maxA = 0.5;
            var minA = -0.5;
            var aStep = 0.01;

            if(randomy == 0){
                y = y - aStep;
            } else if(randomy == 1){
                y = y + aStep;
            }

            if(y > maxA){
                y = maxA-(y-maxA);
                //y = maxA
            } else if(y < minA){
                y = minA-(y-minA);
                //y = minA
            }

            //   console.log(randomy,"y ", y);
            breakpoint[i].y = y;

        } 

        if(i == breakpoint.length-1){
            breakpoint[i].y = 0;
            
        }

        //compute the slope and y intercept for these new walking breakpoints

        breakpoint[i].x1 = breakpoint[last].x;
        breakpoint[i].y1 = breakpoint[last].y;

        breakpoint[i].m = (breakpoint[i].y-breakpoint[last].y1)/(breakpoint[i].x-breakpoint[last].x1); 

        breakpoint[i].b = breakpoint[i].y-(breakpoint[i].m*breakpoint[i].x); 

        last = i;
        next++;
    }
    //console.log(" test");

}

var index = 0;

scriptNode.onaudioprocess = function(audioProcessingEvent){
    
    var lastPoint = 0;

    var outputBuffer = audioProcessingEvent.outputBuffer;
    var outputData = outputBuffer.getChannelData(0);
        for(var j = 0; j < outputData.length; j+=freq){
            // linearly interpolate between the new breakpoit positions
            for(var i = 0; i < breakpoint.length; i++){

                var y = breakpoint[lastPoint].y; 
                    
                if(y >= breakpoint[i].y){
                        // y = m(x)+b
                        y = (breakpoint[i].m*index)+breakpoint[i].b;
                        outputData[j] = y; 
                        index++; 
                }  

                if(y <= breakpoint[i].y){
                        //y = m(x)+b
                        y = (breakpoint[i].m*index)+breakpoint[i].b;
                        outputData[j] = y; 
                        index++;  
                }
               
                lastPoint = i;
                  if(index >= breakpoint[breakpoint.length-1].x){
                    index = 0;
                    //console.log("DEBUG!");
                }  

            }
           
        } 

    walk(); //use random walk to generate new x/y position for each breakpoint
}

function debug(){
    
    console.log(index);
    console.log(breakpoint[breakpoint.length-1].x);

    
}




function canvasDraw(){
    window.requestAnimationFrame(canvasDraw);

    context.globalAlpha = 0.2
    context.fillStyle = "#EEE"
    context.fillRect(0,0,canvas.width,canvas.height)

    context.globalAlpha = 1
    //this is cool but saving for later
    //context.strokeStyle = "rgb("+breakpoint[1].x%255+","+breakpoint[1].y*100+",0)";
    context.strokeStyle = "black";
    context.lineWidth = 6;

    context.beginPath();
    context.moveTo(0,canvas.height/2)
    for (var i=0;i<breakpoint.length;i++) {
        context.lineTo((breakpoint[i].x/scriptNode.bufferSize)*canvas.width,breakpoint[i].y*canvas.height+canvas.height/2)
    }
   // context.lineTo(canvas.width,canvas.height/2)
    context.stroke()
    context.closePath()

}

function play(){

    sine.connect(actx.destination);
   // sine.start();
    scriptNode.connect(actx.destination);
}

function pressed(){
<<<<<<< HEAD
    init(20);
=======
    init(7);
>>>>>>> gh-pages
    console.log(breakpoint[breakpoint.length-1].x);
    play();
    canvasDraw();
}

    </script>
</html>